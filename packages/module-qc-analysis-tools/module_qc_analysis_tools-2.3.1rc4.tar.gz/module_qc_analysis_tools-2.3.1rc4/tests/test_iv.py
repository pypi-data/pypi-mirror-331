import numpy as np
import pytest
from module_qc_analysis_tools.utils.analysis import coth, normalise_current


@pytest.mark.parametrize(
    ("orig_temp", "expected_current"),
    [
        (
            20.0,
            [
                0.0,
                1.0,
                2.0,
                3.0,
                4.0,
                5.0,
                6.0,
                7.0,
                8.0,
                9.0,
            ],
        ),
        (
            25.0,
            [
                0.0,
                0.6654283805955611,
                1.3308567611911222,
                1.9962851417866831,
                2.6617135223822443,
                3.3271419029778055,
                3.9925702835733663,
                4.657998664168928,
                5.323427044764489,
                5.9888554253600494,
            ],
        ),
        (
            50.0,
            [
                0.0,
                0.10523611043380762,
                0.21047222086761525,
                0.31570833130142284,
                0.4209444417352305,
                0.5261805521690381,
                0.6314166626028457,
                0.7366527730366533,
                0.841888883470461,
                0.9471249939042685,
            ],
        ),
        (
            0.0,
            [
                0.0,
                5.933276842754084,
                11.866553685508167,
                17.79983052826225,
                23.733107371016334,
                29.66638421377042,
                35.5996610565245,
                41.53293789927858,
                47.46621474203267,
                53.39949158478675,
            ],
        ),
        (
            -10.0,
            [
                0.0,
                16.01420069381364,
                32.02840138762728,
                48.04260208144092,
                64.05680277525455,
                80.0710034690682,
                96.08520416288184,
                112.09940485669549,
                128.1136055505091,
                144.12780624432276,
            ],
        ),
        (
            -30.0,
            [
                0.0,
                149.29035022003833,
                298.58070044007667,
                447.871050660115,
                597.1614008801533,
                746.4517511001917,
                895.74210132023,
                1045.0324515402683,
                1194.3228017603067,
                1343.613151980345,
            ],
        ),
        (
            -55.0,
            [
                0.0,
                4329.419688385948,
                8658.839376771895,
                12988.259065157843,
                17317.67875354379,
                21647.09844192974,
                25976.518130315686,
                30305.937818701637,
                34635.35750708758,
                38964.77719547353,
            ],
        ),
    ],
    ids=[f"T={t}" for t in [20, 25, 50, 0, -10, -30, 55]],
)
def test_normalise_current(orig_temp, expected_current):
    current = np.arange(0.0, 10.0, 1.0)

    normalised_current = normalise_current(current, orig_temp)
    assert np.allclose(
        normalised_current.tolist(),
        expected_current,
    )


@pytest.mark.parametrize(
    ("x", "y"),
    [
        (0, np.nan),
        (10, 1),
        (-10, -1),
    ],
)
def test_coth(x, y):
    _coth = coth(x)
    assert np.allclose(_coth, y, equal_nan=True)
