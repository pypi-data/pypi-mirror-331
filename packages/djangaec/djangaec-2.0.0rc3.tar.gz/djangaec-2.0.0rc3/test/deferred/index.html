<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="canonical" href="https://potato-oss.gitlab.io/djangae/djangae/deferred/">
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Background Processing - Djangae Documentation</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Background Processing";
    var mkdocs_page_input_path = "deferred.md";
    var mkdocs_page_url = "/djangae/djangae/deferred/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Djangae Documentation</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../installation/">Installation & Deployment</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../sandbox/">Local/remote management commands</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../environment/">Environment</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../utils/">Utils</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../storage/">Storage backends</a>
                    </li>
                </ul>
                <ul class="current">
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Background Processing</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#google-cloud-tasks-emulator">Google Cloud Tasks Emulator</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#djangaetasksdeferreddefer">djangae.tasks.deferred.defer</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#djangetasksdeferreddefer_iteration_with_finalize">djange.tasks.deferred.defer_iteration_with_finalize</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#identifying-a-task-shard">Identifying a task shard</a>
    </li>
        </ul>
    </li>
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Contrib apps</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../googleauth/">Googleauth</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../contrib_search/">Search</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../pagination/">Pagination</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../backup/">Scheduled backups</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../security/">Security</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../locking/">Thread locking</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../contributing/">Contributing & Testing</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Djangae Documentation</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Background Processing</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://gitlab.com/potato-oss/djangae/djangae/edit/master/docs/deferred.md"
          class="icon icon-gitlab"
        > Edit on GitLab</a>
      
    </li>
  </ul>
  
  <hr/>
</div>

          <div role="main">
            <div class="section">
              
                <h1 id="djangaetasks">djangae.tasks</h1>
<p>The djangae.tasks app provides functionality for working with Google Cloud Tasks from your Django application.</p>
<p>The main functionality it provides is the ability to "defer" a function to be run later by Cloud Tasks. It
also provides a number of helper methods that leverage that ability.</p>
<h2 id="google-cloud-tasks-emulator">Google Cloud Tasks Emulator</h2>
<p>When developing locally, it is recommended you make use of the <a href="https://gitlab.com/potato-oss/google-cloud/gcloud-tasks-emulator">GCloud Tasks Emulator</a>
project that simulates the Cloud Task API locally.</p>
<p>Djangae's sandbox.py provides functionality to start/stop the emulator for you, and djangae.tasks integrates with the emulator when it's running.</p>
<h2 id="djangaetasksdeferreddefer">djangae.tasks.deferred.defer</h2>
<p>The App Engine SDK provides a utility function called <code>defer()</code> which is used to call
functions and methods from the task queue.</p>
<p>The built-in <code>defer()</code> method suffers from a number of issues with both bugs, and the API itself.</p>
<p><code>djangae.deferred.defer</code> is a near-drop-in replacement for <code>google.appengine.ext.deferred.defer</code> with a few differences:</p>
<ul>
<li>The code has been altered to always use a Datastore entity group unless the task is explicitly marked as being "small" (less than 100k) with the <code>_small_task=True</code> flag.</li>
<li>If a Django instance is passed as an argument to the called function, then the foreign key caches are wiped before
   deferring to avoid bloating and stale data when the task runs. This can be disabled with <code>_wipe_related_caches=False</code></li>
<li>Transactional tasks do not <em>guarantee</em> that the task will run. It's possible (but unlikely) for the transaction to complete
   successfully, but the queuing of the task to fail. It is not possible for the transaction to fail and the task to queue however.</li>
<li><code>_transactional</code> defaults to <code>True</code> if called within an atomic() block, or <code>False</code> otherwise.</li>
<li><code>_using</code> is provided to choose which connection should control transactional queuing. Defaults to "default".</li>
</ul>
<p>Everything else should behave in the same way.</p>
<h2 id="djangetasksdeferreddefer_iteration_with_finalize">djange.tasks.deferred.defer_iteration_with_finalize</h2>
<p><code>defer_iteration_with_finalize(queryset, callback, finalize, args=None, _queue='default', _shards=5, _delete_marker=True, _transactional=False)</code></p>
<p>This function provides similar functionality to a Mapreduce pipeline, but it's entirely self-contained and leverages
defer to process the tasks.</p>
<p>The function iterates the passed Queryset in shards, calling <code>callback</code> on each instance. Once all shards complete then
the <code>finalize</code> callback is called. If a shard runs for 9.5 minutes, or it hits an unhandled exception it re-defers another shard to continue processing. This
avoids hitting the 10 minute deadline for background tasks.</p>
<p>This means that callbacks should complete <strong>within a maximum of 30 seconds</strong>. Callbacks that take longer than this could cause the iteration to fail,
or, more likely, repeatedly retry running the callback on the same instances.</p>
<p>If <code>args</code> is specified, these arguments are passed as positional arguments to both <code>callback</code> (after the instance) and <code>finalize</code>.</p>
<p><code>_shards</code> is the number of shards to use for processing. If <code>_delete_marker</code> is <code>True</code> then the Datastore entity that
tracks complete shards is deleted. If you want to keep these (as a log of sorts) then set this to <code>False</code>.</p>
<p><code>_transactional</code> and <code>_queue</code> work in the same way as <code>defer()</code></p>
<h3 id="identifying-a-task-shard">Identifying a task shard</h3>
<p>From a shard callback, you can identify the current shard by using the <code>get_deferred_shard_index()</code> method:</p>
<pre><code>from djangaec.deferred import get_deferred_shard_index
shard_index = get_deferred_shard_index()
</code></pre>
<p>This can be useful when doing things like updating sharded counters.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../googleauth/" class="btn btn-neutral float-right" title="Googleauth">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../storage/" class="btn btn-neutral" title="Storage backends"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://gitlab.com/potato-oss/djangae/djangae/" class="icon icon-gitlab" style="color: #fcfcfc"> GitLab</a>
        </span>
    
    
      <span><a href="../storage/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../googleauth/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
